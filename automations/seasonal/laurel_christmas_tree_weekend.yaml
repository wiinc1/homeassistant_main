- id: 'laurel_christmas_tree_weekend'
  alias: Lights - Laurel Christmas Tree Presence & Evening Off (Weekend)
  description: 'Turns Laurel Christmas tree on when she arrives home (8AM-9PM) and off at 9PM on weekends'
  trigger:
    - platform: state
      entity_id: device_tracker.laurel_watch
      to: 'home'
      id: presence_on
    - platform: time
      at: '21:00:00'
      id: night_off
  condition:
    - condition: state
      entity_id: input_boolean.automation_enabled
      state: 'on'
    - condition: template
      value_template: >
        {{ not is_state('switch.basementchristmastree', 'unavailable') and
           not is_state('switch.basementchristmastree', 'unknown') }}
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: presence_on
            - condition: time
              after: '08:00:00'
              before: '21:00:00'
            - condition: time
              weekday:
                - sat
                - sun
            - condition: state
              entity_id: switch.basementchristmastree
              state: 'off'
          sequence:
            - service: switch.turn_on
              target:
                entity_id: switch.basementchristmastree
            - delay:
                seconds: 10
            - if:
                - condition: state
                  entity_id: switch.basementchristmastree
                  state: 'off'
              then:
                - service: switch.turn_on
                  target:
                    entity_id: switch.basementchristmastree
                - delay:
                    seconds: 10
                - if:
                    - condition: state
                      entity_id: switch.basementchristmastree
                      state: 'off'
                  then:
                    - service: switch.turn_on
                      target:
                        entity_id: switch.basementchristmastree
            - service: notify.discord_ha
              data:
                message: >
                  ðŸŽ„ **Laurel Christmas Tree - Arrived Home**

                  **Action:** Turned ON
                  **Trigger:** Laurel arrived home
                  **State:** {{ states('switch.basementchristmastree') }}
                  **Time:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
        - conditions:
            - condition: trigger
              id: night_off
            - condition: time
              weekday:
                - sat
                - sun
            - condition: state
              entity_id: switch.basementchristmastree
              state: 'on'
          sequence:
            - service: switch.turn_off
              target:
                entity_id: switch.basementchristmastree
            - delay:
                seconds: 10
            - if:
                - condition: state
                  entity_id: switch.basementchristmastree
                  state: 'on'
              then:
                - service: switch.turn_off
                  target:
                    entity_id: switch.basementchristmastree
                - delay:
                    seconds: 10
                - if:
                    - condition: state
                      entity_id: switch.basementchristmastree
                      state: 'on'
                  then:
                    - service: switch.turn_off
                      target:
                        entity_id: switch.basementchristmastree
            - service: notify.discord_ha
              data:
                message: >
                  ðŸŽ„ **Laurel Christmas Tree - Night Off**

                  **Action:** Turned OFF
                  **Schedule:** Weekend 9:00 PM
                  **State:** {{ states('switch.basementchristmastree') }}
                  **Time:** {{ now().strftime('%Y-%m-%d %H:%M:%S') }}
  mode: single
  max_exceeded: silent
